---
title: "Blood Pressure"
output: html_notebook
author: John Ma, Ben Mak, Micheal Chen
---




# Packages
```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(MASS)
library(onewaytests)
library(readxl)
library(leaps)
library(corrplot)
library(MPV)
library(olsrr)
library(ggpubr)
library(lmtest)
```

# Reading and cleaning the data frame
```{r}
bp <- read_xlsx("BloodPressure.xlsx")
bp %>% mutate(married = replace(married, married == 'N', 0))%>% 
  mutate(married = replace(married, married == 'Y', 1)) %>%
  mutate(gender = replace(gender, gender == 'F', 0)) %>%
  mutate(gender = replace(gender, gender == 'M', 1)) %>%
  mutate(smoke = replace(smoke, smoke == 'N', 0)) %>%
  mutate(smoke = replace(smoke, smoke =='Y', 1))-> bp

class(bp$gender) = "double"
class(bp$married) = "double"
class(bp$smoke) = "double"
bp
# Making a testing set and a validation set
set.seed(1004274037)
bp_samp <- sample(1:500, 300, replace=FALSE)
bp_train <- bp[bp_samp,]
bp_valid <- bp[-bp_samp,]

bp_train
bp_valid

```
- set aside 60% observations to create the model and 40% to test the model


# Relationships between covariates
```{r}
bp_cor <- cor(bp_train)

corrplot(bp_cor)
```

# Multicollinearity


VIF: 
```{r}
R_sqr <- summary(bp_full)$r.squared
VIF <- 1/(1-R_sqr)
VIF
```
# Main Effect Full Model

```{r}
bp_full <- lm(data=bp_train, sbp ~ gender + married + smoke + exercise + age + weight + height + overwt + race + alcohol + trt + bmi + stress + salt + chldbear + income + educatn)
summary(bp_full)
```
- p-value is < 0.05, which means that



# Residual diagnostics of the main effect model
```{r}
qqnorm(bp_full$residuals)
qqline(bp_full$residuals)
hist(x=bp_full$residuals, xlab='Residuals')
#augment(bp_full)
ggplot(bp_full, aes(x=.fitted, y=.resid)) + geom_point() + labs(x="Fitted", y="Residuals")+ geom_hline(yintercept = 0)
bc_full <- boxcox(bp_full)
shapiro.test(bp_full$residuals)
bptest(bp_full, studentize = F)
# add bf test here; didnt work earlier
lambda_full <- bc_full$x[which.max(bc_full$y)]
lambda_full
```

- fitted vs residual values look randomly scattered
- normal qq plot looks like its in a straight line
- data seems to be cleaned up here.

- p-value > 0.05, we can conclude the error looks from a normal population

- looks like we can put a transformation on the model

# Tranformed full model
```{r}
k2 <- prod(bp_train$sbp^(1/300))
k1 <- 1/(lambda_full*k2^(lambda_full-1))
bp_train %>% mutate(sbp_full_transformed = k1*(sbp^lambda_full - 1)) -> bp_train
bp_train
bp_full_transformed <- lm(data=bp_train, sbp_full_transformed ~ gender + married + smoke + exercise + age + weight + height + overwt + race + alcohol + trt + bmi + stress + salt + chldbear + income + educatn)
summary(bp_full_transformed)
```

# Residual testing again
```{r}
qqnorm(bp_full_transformed$residuals)
qqline(bp_full_transformed$residuals)
hist(x=bp_full_transformed$residuals, xlab='Residuals')
#augment(bp_full)
ggplot(bp_full_transformed, aes(x=.fitted, y=.resid)) + geom_point() + labs(x="Fitted", y="Residuals")+ geom_hline(yintercept = 0)
bc_full <- boxcox(bp_full_transformed)
shapiro.test(bp_full_transformed$residuals)
bptest(bp_full_transformed, studentize = F)

```








# Backwards elimination


## AIC/BIC 
```{r}
stepAIC(bp_full, direction = "backward")
```
```{r}
#AIC=1942.39
bp_reduced <- lm(sbp ~ gender + smoke + exercise + height + alcohol + trt + bmi + 
    chldbear, data=bp_train)
summary(bp_reduced)
```
- since chldbear has a large 


Checking if removing the terms is better using ANOVA:  
```{r}
anova(bp_reduced, bp_full)
```

- $H_0:$ full model and reduced model give similar effects vs. $H_a:$ full model is better.

- Without interaction terms model -- P-value > 0.05, reduced model is sufficient




# Cross validation for main effect model

```{r}
anova(bp_reduced)
#preds_cols <- c('gender' , 'married' , 'smoke' , 'exercise' , 'age' , 'weight' , 'height' , 'overwt' , 'race' , 'alcohol' , 'trt' ,'bmi' ,'stress' , 'salt' , 'chldbear' , 'income' , 'educatn')

preds_cols <- c('gender' , 'smoke' , 'exercise' , 'height', 'alcohol' , 'trt' ,'bmi' ,'chldbear' )
pred_bp <- predict(bp_reduced, bp_valid[preds_cols])
delta_bp <- bp_valid['sbp'] - pred_bp
n.star <- dim(bp_valid)[1]
MSPR <- sum((delta_bp_int)^2)/n.star
MSPR
```

- MSPR = 666.486
- MSE = 629.6



# PRESS Statistic for interaction model

```{r}
PRESS(bp_reduced)
```





# Graphs of SBP and covariates
```{r}
bp_train  %>% dplyr::select(sbp, age, bmi, height, weight) %>% pivot_longer(c(age, bmi, height,weight), names_to = "xnames", values_to = "x")%>%
  ggplot(aes(x=x, y=(sbp)))  + geom_point() + facet_wrap(~xnames, scales = "free") + geom_smooth(method="lm")


bp_train  %>% dplyr::select(sbp, alcohol, chldbear, educatn, exercise, gender, income, married, overwt, race, salt, smoke, stress, trt) %>% pivot_longer(c(alcohol, chldbear, educatn, exercise, gender, income, married, overwt, race, salt, smoke, stress, trt), names_to = "xnames", values_to = "x") %>% 
  ggplot(aes(x=x, y=(sbp)))  + geom_histogram() + facet_wrap(~xnames, scales = "free")
```

# Influence Diagnostics

```{r}
bp.rstandard <- rstandard(bp_reduced)
bp.rstudent <- rstudent(bp_reduced)
bp.inf <- influence.measures(bp_reduced)
cbind(bp.rstandard, bp.rstudent)
```
- does not seem to have many issues here with outliers



```{r}
bp.inf
```




# Graphical Diagnostics for influence
```{r}
#p1 <- ols_plot_added_variable(bp_reduced)
p2 <- ols_plot_cooksd_chart(bp_reduced)
p3 <- ols_plot_dffits(bp_reduced)
p4 <- ols_plot_resid_lev(bp_reduced)
p5 <- ols_plot_resid_stud_fit(bp_reduced)
p6 <- ols_plot_dfbetas(bp_reduced)
```

# Remedial Measures


# Adding interaction terms 


```{r}
#With interactions
bp_full_int <- lm(data=bp_train, sbp ~ gender + married + smoke + exercise + age + weight + height + race + alcohol + trt + bmi + stress + salt + chldbear + income + educatn + overwt + income:educatn + gender:chldbear + stress:alcohol  + stress:weight + stress:overwt + income:age + weight:overwt + bmi:weight + bmi:height  + alcohol:smoke + height:gender + weight:gender + income:stress + educatn:stress  + smoke:exercise + income:chldbear  + chldbear:married + salt:exercise)

summary(bp_full_int)
```

- since $R^2$ is really low for blood pressure, we need to add more terms. 
- added interaction terms to see if $R^2$ goes up significantly or not.


```{r}
qqnorm(bp_full_int$residuals)
qqline(bp_full_int$residuals)
hist(bp_full_int$residuals)
#augment(bp_full)
ggplot(bp_full_int, aes(x=.fitted, y=.resid)) + geom_point() + geom_hline(yintercept = 0)
boxcox(bp_full_int)
shapiro.test(bp_full_int$residuals)
```
- This model looks like it has residuals that are


# AIC/BIC with interaction terms
```{r}
stepAIC(bp_full_int, direction = "backward")
#AIC=1934.13
```



```{r}
bp_reduced_int <- lm(sbp ~ gender + smoke + exercise + age + weight + alcohol + trt + 
    stress + salt + chldbear + income + educatn + income:educatn + 
    weight:stress + age:income + smoke:alcohol + exercise:salt, data=bp_train)
summary(bp_reduced_int)
```
# Multicollinearity
VIF:
```{r}
R_int <- summary(bp_full_int)$r.squared
VIF_int <- 1/(1-R_int)
VIF_int
```
- low VIF, not likely to have a multicollinearity problem with this model

```{r}
anova(bp_reduced_int, bp_full_int)
```
- With interaction terms model -- P-value > 0.05, reduced model is sufficient


# Cross Validation for interaction model
```{r}
# fit model for training set
# gender + married + smoke + exercise + age + height + race + 
#    alcohol + trt + bmi + stress + chldbear + income + educatn + 
#    overwt + income:educatn + trt:overwt + married:stress + 
#    smoke:exercise + alcohol:educatn

bp_valid %>% mutate(`income:educatn` = income*educatn, `trt:overwt` = trt*overwt, `married:stress` = married*stress, `smoke:exercise` = smoke*exercise, `alcohol:educatn` = alcohol*educatn) -> bp_valid_int
anova(bp_reduced_int)

pred_cols_int <- c('gender', 'married', 'smoke', 'exercise', 'age', 'height', 'race', 'alcohol' , 'trt', 'bmi', 'stress', 'chldbear', 'income', 'educatn', 'overwt', 'income:educatn', 'trt:overwt', 'smoke:exercise', 'alcohol:educatn')

pred_bp_int <- predict(lm_AIC_int, bp_valid_int[pred_cols_int])
delta_bp_int <- bp_valid['sbp'] - pred_bp_int
n.star_int <- dim(bp_valid_int)[1]
MSPR_int <- sum((delta_bp_int)^2)/n.star_int 
MSPR_int
```

- MSE = 607.6
- MSPR = 666.486


```{r}
PRESS(lm_AIC_int)
```


# Graphical Diagnostics 

```{r}
p2_int <- ols_plot_cooksd_chart(bp_reduced)
p3_int <- ols_plot_dffits(bp_reduced)
p4_int <- ols_plot_resid_lev(bp_reduced)
p5_int <- ols_plot_resid_stud_fit(bp_reduced)
p6_int <- ols_plot_dfbetas(bp_reduced)
```


# Remedial measures



# Conclusion

- Interaction terms made it so MSE is further away from MSPR which isn't what we want.
- all models were significant since their p-values < 0.05
- AIC with the interaction terms are much better.
- $R^2$ is better with the interaction terms
- both models are significant
- $R^2$ in general is low, we may need more predictors
- $R^2$ is really low even after adding interaction terms, this means we are missing a couple of important predictors.
- our best model would be the one with interactions so far