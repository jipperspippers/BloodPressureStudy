---
title: "BloodPressure"
output: html_notebook
---
# Packages
```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(MASS)
library(onewaytests)
library(readxl)
library(leaps)
library(corrplot)
library(MPV)
```

# Reading and cleaning the data frame
```{r}
bp <- read_xlsx("BloodPressure.xlsx")
bp %>% mutate(married = replace(married, married == 'N', 0))%>% 
  mutate(married = replace(married, married == 'Y', 1)) %>%
  mutate(gender = replace(gender, gender == 'F', 0)) %>%
  mutate(gender = replace(gender, gender == 'M', 1)) %>%
  mutate(smoke = replace(smoke, smoke == 'N', 0)) %>%
  mutate(smoke = replace(smoke, smoke =='Y', 1))-> bp

class(bp$gender) = "double"
class(bp$married) = "double"
class(bp$smoke) = "double"
bp
# Making a testing set and a validation set
set.seed(1004274037)
bp_samp <- sample(1:500, 300, replace=FALSE)
bp_train <- bp[bp_samp,]
bp_valid <- bp[-bp_samp,]

bp_train
bp_valid

```
- set aside 60% observations to create the model and 40% to test the model

```{r}
#No interactions
bp_full <- lm(data=bp_train, sbp ~ gender + married + smoke + exercise + age + weight + height + overwt + race + alcohol + trt + bmi + stress + salt + chldbear + income + educatn)
summary(bp_full)
```

# Residual diagnostics
```{r}
qqnorm(bp_full$residuals)
qqline(bp_full$residuals)
hist(bp_full$residuals)
#augment(bp_full)
ggplot(bp_full, aes(x=.fitted, y=.resid)) + geom_point() + geom_hline(yintercept = 0)
boxcox(bp_full)
# add bf test here; didnt work earlier
```

- fitted vs residual values look randomly scattered
- normal qq plot looks like its in a stright line
- data seems to be cleaned up here.


Tests:  
```{r}
shapiro.test(bp_full$residuals)
#bf.test(data=bp_train, sbp ~ gender + married + smoke + exercise + age + weight + height + overwt + race + alcohol + trt + bmi + stress + salt + chldbear + income + educatn)
```

- p-value > 0.05, we can conclude the error looks from a normal population


```{r}
#With interactions
bp_full_int <- lm(data=bp_train, sbp ~ gender + married + smoke + exercise + age + weight + height + race + alcohol + trt + bmi + stress + salt + chldbear + income + educatn + overwt + income:educatn + age:chldbear + age:stress + trt:age + trt:overwt + trt:smoke + trt:chldbear + bmi:overwt + stress:alcohol + stress:chldbear + stress:weight + stress:overwt + income:age + trt:stress + weight:overwt + bmi:weight + bmi:height + smoke:overwt + gender:smoke + alcohol:smoke + salt:stress + income:stress + educatn:stress + race:stress + married:stress + smoke:exercise + income:chldbear + educatn:alcohol + smoke:educatn + alcohol:salt + alcohol:income + chldbear:married)

summary(bp_full_int)
```

- since $R^2$ is really low for blood pressure, we need to add more terms. 
- adding interaction variables makes sense because we know that certain things
rely on eachother



# Checks for multicollinearity
```{r}
bp_cor <- cor(bp_train)

corrplot(bp_cor)
```




# Backwards elimination


# AIC/BIC 
```{r}
stepAIC(bp_full, direction = "backward")
```

# AIC/BIC with interaction terms
```{r}
stepAIC(bp_full_int, direction = "backward")
```


# Comparing a model with interaction variables against the main effect

```{r}
#AIC=1934.13
lm_AIC_int <- lm(sbp ~ gender + married + smoke + exercise + age + height + race + 
    alcohol + trt + bmi + stress + chldbear + income + educatn + 
    overwt + income:educatn + trt:overwt + married:stress + 
    smoke:exercise + alcohol:educatn, data=bp_train)
summary(lm_AIC_int)


#AIC=1942.39
lm_AIC <- lm(sbp ~ gender + smoke + exercise + height + alcohol + trt + bmi + 
    chldbear, data=bp_train)
summary(lm_AIC)
```

Checking if removing the terms is better using ANOVA:  
```{r}
anova(lm_AIC, bp_full)
anova(lm_AIC_int, bp_full_int)
```

- $H_0:$ full model and reduced model give similar effects vs. $H_a:$ full model is better.

- Without interaction terms model -- P-value > 0.05, reduced model is sufficient
- With interaction terms model -- P-value > 0.05, reduced model is sufficient



```{r}
leaps <- regsubsets(sbp ~ gender + married + smoke + exercise + age + weight + height + race + alcohol + trt + bmi + stress + salt + chldbear + income + educatn, data=bp_train, nbest = 10)
s <- summary(leaps)
n <- length(bp_train$sbp)
p <- apply(s$which, 1, sum)
s$aic <- s$bic - log(n)*p + 2*p
with(s, round(cbind(which, rsq, adjr2,cp,bic,aic),3))
options(max.print=9999999)
```

Things left to do:
- make sure that we do the DFFITS and show diagrams
- validate model with test set and modelling set
- make the visual part look a bit better  
- anova maybe?


# Cross Validation for interaction model
```{r}
# fit model for training set
# gender + married + smoke + exercise + age + height + race + 
#    alcohol + trt + bmi + stress + chldbear + income + educatn + 
#    overwt + income:educatn + trt:overwt + married:stress + 
#    smoke:exercise + alcohol:educatn

bp_valid %>% mutate(`income:educatn` = income*educatn, `trt:overwt` = trt*overwt, `married:stress` = married*stress, `smoke:exercise` = smoke*exercise, `alcohol:educatn` = alcohol*educatn) -> bp_valid_int
anova(lm_AIC_int)

pred_cols_int <- c('gender', 'married', 'smoke', 'exercise', 'age', 'height', 'race', 'alcohol' , 'trt', 'bmi', 'stress', 'chldbear', 'income', 'educatn', 'overwt', 'income:educatn', 'trt:overwt', 'smoke:exercise', 'alcohol:educatn')

pred_bp_int <- predict(lm_AIC_int, bp_valid_int[pred_cols_int])
delta_bp_int <- bp_valid['sbp'] - pred_bp_int
n.star_int <- dim(bp_valid_int)[1]
MSPR_int <- sum((delta_bp_int)^2)/n.star_int 
MSPR_int
```


- MSE = 607.6
- MSPR = 666.486


# Cross validation for main effect model

```{r}
anova(lm_AIC)
preds_cols <- c('gender' , 'married' , 'smoke' , 'exercise' , 'age' , 'weight' , 'height' , 'overwt' , 'race' , 'alcohol' , 'trt' ,'bmi' ,'stress' , 'salt' , 'chldbear' , 'income' , 'educatn')
pred_bp <- predict(lm_AIC, bp_valid[preds_cols])
delta_bp <- bp_valid['sbp'] - pred_bp
n.star <- dim(bp_valid)[1]
MSPR <- sum((delta_bp_int)^2)/n.star
MSPR
```

- MSPR = 666.486
- MSE = 629.6



# PRESS Statistic for interaction model

```{r}
PRESS(lm_AIC)
PRESS(lm_AIC_int)
```


# Multicollinearity
- Estimated regression coefficients with an opposite sign of that expected from theoretical considerations or prio e
- Standard error is not large -- not a sign 
- There is a small change in the coefficient of determination when a variable is added/delted
- High correlation between predictor variables overwt, weight, height and BMI -- related because ...
- high correlation between chldbear and gender -- makes sense because only women can bear children.
- add interaction terms 

VIF: 
```{r}
# Without the interaction terms



# With the interaction  terms
```




# Graphs of SBP and covariates
```{r}
bp_train  %>% pivot_longer(c(gender:educatn), names_to = "xnames", values_to = "x")%>% 
  ggplot(aes(x=x, y=(sbp)))  + geom_point() + facet_wrap(~xnames, scales = "free") 
```

# Graphs of covariates


# Conclusion

- AIC with the interaction terms are much better.
- $R^2$ is better with the interaction terms
- both models are significant
- $R^2$ in general is low, we may need more predictors
- $R^2$ is really low even after adding interaction terms, this means we are missing a couple of important predictors